<?xml version="1.0"?>

<!-- 
  If Apache Ant is installed, the framework can be tested using the command
      ant -f test.xml
      
  See <http://ant.apache.org/> for instructions on installing Apache Ant.
-->
 
<project name="MOEA Framework Testing" basedir="." default="test">

	<property file="META-INF/build.properties" />
	<property environment="env" />
	
	<path id="classpath">
		<fileset dir="lib" includes="*.jar" />
	</path>
	
	<path id="requiredfiles">
		<fileset file="README" />
		<fileset file="LICENSE" />
		<fileset file="NEWS" />
		<fileset file="HELP" />
	</path>
	
	<target name="check-dependencies">
		<available classname="org.junit.Assert" classpathref="classpath"
				property="junit-exists" />
		
		<!-- Commented to always force recompiling of the JAR -->
		<!--<available file="dist/${shortname}-${version}.jar" 
				property="binary-exists" />-->
	</target>
	
	<target name="check-binary" depends="check-dependencies" 
			unless="binary-exists">
		<ant target="build-binary" />
	</target>
	
	<target name="check-junit" depends="check-dependencies"
			unless="junit-exists">
		<echo>==================================================================</echo>
		<echo> The JUnit library is missing from your classpath.  Please</echo>
		<echo> download the latest JUnit 4 library from http://www.junit.org/,</echo>
		<echo> and place the JAR in the lib/ folder.</echo> 
		<echo>==================================================================</echo>
			
		<fail message="JUnit library missing"/>
	</target>
	
	<target name="build-c">
		<exec executable="make" dir="auxiliary/c/" failifexecutionfails="false">
			<arg value="clean" />
		</exec>
			
		<exec executable="make" dir="auxiliary/c/"
				failifexecutionfails="false" />
	</target>
	
	<target name="build-tests" 
			depends="check-dependencies,check-binary,check-junit">
		<delete dir="build" />
		<mkdir dir="build" />

		<javac destdir="build" debug="${java.debug}" 
				includeantruntime="false">
			<src path="test" />
			<src path="examples" />
			<classpath>
				<path refid="classpath" />
				<pathelement location="dist/${shortname}-${version}.jar" />
			</classpath>
		</javac>

		<copy todir="build">
			<fileset excludes="**/*.java" dir="test" />
		</copy>
		
		<copy todir="build/META-INF">
			<path refid="requiredfiles" />
		</copy>

		<jar basedir="build" 
			jarfile="dist/${shortname}-${version}-Test.jar" />
	</target>

	<target name="run-tests" depends="build-tests, build-c">		
		<mkdir dir="test-results" />
		<mkdir dir="test-results/raw" />
	
		<junit printsummary="on" haltonfailure="false" 
				tempdir="test-results/raw" errorproperty="junit.failure"
				failureproperty="junit.failure">
			<classpath>
				<path refid="classpath" />
				<fileset file="dist/${shortname}-${version}.jar" />
				<fileset file="dist/${shortname}-${version}-Test.jar" />
			</classpath>
			<batchtest todir="test-results/raw">
				<formatter type="xml" />
				<zipfileset src="dist/${shortname}-${version}-Test.jar">
					<include name="**/*Test.class" />
					<exclude name="org/moeaframework/algorithm/AlgorithmTest.class" />
					<exclude name="org/moeaframework/core/indicator/IndicatorTest.class" />
					<exclude name="org/moeaframework/analysis/collector/CollectorTest.class" />
					<exclude name="org/moeaframework/core/operator/DistributionVariationTest.class" />
					<exclude name="org/moeaframework/core/operator/MeanCentricVariationTest.class" />
					<exclude name="org/moeaframework/core/operator/ParentCentricVariationTest.class" />
					<exclude name="org/moeaframework/core/operator/ParentImmutabilityTest.class" />
					<exclude name="org/moeaframework/core/operator/PointCrossoverTest.class" />
					<exclude name="org/moeaframework/core/operator/TypeSafetyTest.class" />
					<exclude name="org/moeaframework/problem/ProblemTest.class" />
					<exclude name="org/moeaframework/util/sequence/SequenceTest.class" />
					<exclude name="org/moeaframework/util/statistics/IntervalRatioStatisticalTest.class" />
					<exclude name="org/moeaframework/util/statistics/KruskalWallisTest.class" />
					<exclude name="org/moeaframework/util/statistics/MannWhitneyUTest.class" />
					<exclude name="org/moeaframework/util/statistics/OrdinalStatisticalTest.class" />
					<exclude name="org/moeaframework/util/statistics/SingleSampleTTest.class" />
					<exclude name="org/moeaframework/util/statistics/StatisticalTest.class" />
					<exclude name="org/moeaframework/util/statistics/TwoSampleTTest.class" />
					<exclude name="org/moeaframework/util/statistics/WilcoxonSignedRanksTest.class" />
				</zipfileset>
			</batchtest>
		</junit>

		<junitreport todir="test-results">
			<fileset dir="test-results/raw">
				<include name="TEST-*.xml"/>
			</fileset>
			<report format="frames" todir="test-results"/>
		</junitreport>
	</target>
	
	<target name="test" depends="run-tests" if="junit.failure" 
			description="Run the unit tests">
		<echo>==================================================================</echo>
		<echo> One or more unit tests failed!  Open test-results/index.html to</echo> 
		<echo> see which tests failed.</echo>
	    <echo> </echo>
		<echo> Note: due to the stochastic nature of the MOEA Framework, there</echo>
		<echo> is a small chance that some correct tests will fail.  Please</echo>
		<echo> repeat the tests prior to notifying the developers.</echo>
		<echo>==================================================================</echo>
	
	    <fail message="Unit test(s) failed.  See reports!"/>
	</target>
	
</project>